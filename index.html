<!DOCTYPE html>
<html>
<head>
    <title>Predict a signal (433 mhz) for Athom Homey</title>
    <style type="text/css">

        * {
            margin: 0;
            padding: 0;
        }

        body {
            font: small arial,sans-serif;
            font-family: arial, sans-serif;
        }

        p {
            margin: 5px 0;
        }

        .container {
            max-width: 760px;
            margin: 0 auto;
        }

        .section {
            /*border: 1px solid #ccc;*/
            box-shadow: 0 2px 2px 0 rgba(0,0,0,0.16), 0 0 0 1px rgba(0,0,0,0.08);
            border-radius: 4px;
            padding: 13px;
            margin: 10px;
        }

        .row {
            margin: 10px 0 1px 0;
        }

        .row > label {
            display: block;
        }

        .row > input {
            width: 98%;
            margin: 2px 0 7px 0;
            padding: 5px;
        }

        input[type='button'] {
            margin: 7px 10px 7px 0;
            padding: 5px;
        }

        .section h3 {
            margin-bottom: 10px;
            padding: 0;
        }

        .section > input {
            display: block;
            padding: 4px;
            margin: 2px;
        }

        textarea {
            width: 100%;
            height: 100px;
            background: white;
            padding: 3px;
        }

        pre {
            outline: 1px solid #ccc;
            padding: 5px;
        }

        .string {
            color: green;
        }

        .number {
            color: darkorange;
        }

        .boolean {
            color: blue;
        }

        .null {
            color: magenta;
        }

        .key {
            color: red;
        }
    </style>
    <script type="text/javascript">

        // helper
        function $el(id) { return window.document.getElementById(id); }

        function syntaxHighlight(json) {
            if (typeof json != 'string') {
                json = JSON.stringify(json, undefined, 2);
            }
            json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
                var cls = 'number';
                if (/^"/.test(match)) {
                    if (/:$/.test(match)) {
                        cls = 'key';
                    } else {
                        cls = 'string';
                    }
                } else if (/true|false/.test(match)) {
                    cls = 'boolean';
                } else if (/null/.test(match)) {
                    cls = 'null';
                }
                return '<span class="' + cls + '">' + match + '</span>';
            });
        }

        // internal
        var _recording;
        var _calculating;
        var _errorTrigger;

        // remote access
        var $ipAddress;
        var $accessToken;

        // recording
        var $recordBtn;
        var $calculateBtn;
        var $recordData;

        // input params
        var $sofl;
        var $eofl;
        var $predictedSignalCount;
        var $predictedSignalLength;
        var $predictedWordLength;
        var $predictedWords;
        var $tolerance;

        // output
        var $output;
        var $payloads;

        function init() {

            // remote access
            $ipAddress = $el('ip-address');
            $accessToken = $el('access-token');

            // recording
            $recordBtn = $el('record-button');
            $calculateBtn = $el('calculate-button');
            $recordData = $el('record-data');

            // input params
            $sofl = $el('sofl');
            $eofl = $el('eofl');
            $predictedSignalCount = $el('predicted-signal-count');
            $predictedSignalLength = $el('predicted-signal-length');
            $predictedWordLength = $el('predicted-word-length');
            $predictedWords = $el('predicted-words');
            $tolerance = $el('tolerance');

            // output
            $output = $el('output');
            $payloads = $el('payloads');

            // load values from local storage
            $ipAddress.value = window.localStorage.getItem('ip-address');
            $accessToken.value = window.localStorage.getItem('access-token');

            // register to events
            updateRecordingButton();
            $ipAddress.oninput = () => window.localStorage.setItem('ip-address', $ipAddress.value);
            $accessToken.oninput = () => {
                updateRecordingButton();
                window.localStorage.setItem('access-token', $accessToken.value);
            };
            $recordBtn.onclick = () => record();
            $calculateBtn.onclick = () => calculate($recordData);
            $recordData.oninput = () => {
                window.localStorage.setItem('record-data', $recordData.value);
                calculate($recordData);
            }
            $sofl.oninput = () => calculate($sofl);
            $eofl.oninput = () => calculate($eofl);
            $predictedSignalCount.oninput = () => calculate($predictedSignalCount);
            $predictedSignalLength.oninput = () => calculate($predictedSignalLength);
            $predictedWordLength.oninput = () => calculate($predictedWordLength);
            $predictedWords.oninput = () => calculate($predictedWords);
            $tolerance.oninput = () => calculate($tolerance);

            // load previous recorded signal
            var recordData = window.localStorage.getItem('record-data');
            if (recordData) {
                $recordData.value = recordData;
                calculate($recordData);
            }
        }

        function clear() {
            // TODO: Clear previous calculation
            this.displayError(undefined);
            this.displaySignal(undefined);
        }

        function setDefaultInputs() {
            $sofl.value = '';
            $eofl.value = '';
            $predictedSignalCount.value = '';
            $predictedSignalLength.value = '';
            $predictedWordLength.value = '';
            $predictedWords.value = '';
            $tolerance.value = '';
        }

        function api(method, url, data, callback) {
           
            try {
                if (!$ipAddress.value)
                    throw Error('No ip-address provided');
                if (!$accessToken.value)
                    throw Error('No access-token provided');

                var xhttp = new XMLHttpRequest();
                xhttp.open("POST", 'http://' + $ipAddress.value + '/api' + url, true);
                xhttp.setRequestHeader("Content-type", "application/json");
                xhttp.setRequestHeader("Authorization", "Bearer " + $accessToken.value);
                xhttp.onreadystatechange = function (e) {
                    if (callback && this.readyState == 4) {
                        if (this.status == 403) {
                            callback('Unauthorized (403): Invalid authorization bearer token', null);
                        }
                        else if (this.status == 200) {
                            callback(null, this.responseText);
                        } else {
                            callback(this.responseText, null);
                        }
                    }
                };
                xhttp.send();
            } catch (e) {
                if (callback)
                    callback('Api request faild: Please check the provided ip-address for your Homey. \nERROR: ' + e.message, null);
            }
        }

        function updateRecordingButton() {
            $recordBtn.disabled = _recording || !$accessToken.value || !$ipAddress.value;
        }

        function record() {
            console.log('start recording');
            
            setDefaultInputs();
            $output.innerHTML = '';
            $payloads.innerHTML = '';

            _recording = true;
            updateRecordingButton();

            $recordData.value = 'Recording for 10 sec...Please be patience & send your signal multiple times (press button on remote)';
            $recordData.disabled = true;
            api('POST', '/manager/rf/record', {}, (err, result) => {
                console.log('done recording');

                _recording = false;
                updateRecordingButton();

                if (result) {
                    var recordData = JSON.parse(result).result;
                    var recordStr = JSON.stringify(recordData);
                    $recordData.disabled = false;
                    $recordData.value = recordStr;
                    window.localStorage.setItem('record-data', recordStr);

                    calculate($recordData, recordData);
                }
                if (err) {
                    $recordData.value = err;
                    $output.innerHTML = err;
                    console.log(err);
                    markError($recordData);
                }
            });
        }

        function calculate(trigger, recordData) {
            if (_recording || _calculating)
                return;

            if (trigger == $recordData)
                setDefaultInputs();

            try {
                _calculating = true;
                clearError();

                if (!recordData) {
                    var recordInput = ($recordData.value || '').trim();
                    if (!recordInput)
                        return;

                    recordData = JSON.parse(recordInput);
                }

                if (!Array.isArray(recordData))
                    throw Error("No valid record data provided");

                // input data
                var sofl = $sofl.value ? parseInt($sofl.value) : 1; // TODO: Auto try multiple sofl values & compare the results
                var eofl = $eofl.value ? parseInt($eofl.value) : 0; // TODO: Auto try multiple sofl values & compare the results
                var predictedSignalCount = $predictedSignalCount.value ? parseInt($predictedSignalCount.value) : 0;
                var predictedSignalLength = trigger == $predictedSignalCount ? 0 : $predictedSignalLength.value ? parseInt($predictedSignalLength.value) : 0;
                var predictedWordLength = $predictedWordLength.value ? parseInt($predictedWordLength.value) : 2;
                var predictedWords = trigger != $predictedWordLength && $predictedWords.value && $predictedWords.value[0] === '[' ? JSON.parse($predictedWords.value) : null;
                var tolerance = $tolerance.value ? parseInt($tolerance.value) : 100;

                if (predictedWordLength < 1 || predictedWordLength > 100) {
                    trigger = $predictedWordLength;
                    throw Error("Invalid word length: try 2-6");
                }

                // calculate
                var result; // Note: best result
                var results = [];
                if (trigger == $recordData) {
                    for (predictedWordLength = 2; predictedWordLength <= 6; predictedWordLength++) {
                        for (eofl = 0; eofl <= predictedWordLength; eofl++) {
                            for (sofl = 0; sofl <= predictedWordLength; sofl++) {
                                var current = signalDef(recordData, sofl, eofl, predictedSignalCount, predictedSignalLength, predictedWordLength, predictedWords, tolerance);
                                current.payloads = analyze(current);
                                if (current.payloads && current.payloads.match) {
                                    results.push(current);
                                }

                                if (!result || (current.payloads && current.payloads.match > result.payloads.match)) {
                                    result = current; // TODO: also override if contains ? (or reduce match %)
                                }
                                if (result.payloads.guess.indexOf('?') !== -1 && current.payloads.guess.indexOf('?') === -1) {
                                    result = current;
                                }
                            }
                        }
                    }

                } else {
                    result = signalDef(recordData, sofl, eofl, predictedSignalCount, predictedSignalLength, predictedWordLength, predictedWords, tolerance);
                    result.payloads = analyze(result);
                    results.push(result);
                }

                // display
                console.log(results);

                // inputs
                if (trigger != $sofl) $sofl.value = result.sofl;
                if (trigger != $eofl) $eofl.value = result.eofl;
                if (trigger != $predictedSignalCount) $predictedSignalCount.value = result.predictedSignalCount;
                if (trigger != $predictedSignalLength) $predictedSignalLength.value = result.predictedSignalLength;
                if (trigger != $predictedWordLength) $predictedWordLength.value = result.predictedWordLength;
                if (trigger != $predictedWords) $predictedWords.value = JSON.stringify(result.predictedWords);
                if (trigger != $tolerance) $tolerance.value = result.tolerance;

                // output
                $output.innerHTML = syntaxHighlight(result.signal);
                $output.style.outline = '1px solid #ccc';

                displayPayloads(results, result);
            }
            catch (e) {
                console.log(e);
                $output.innerHTML = 'ERROR: ' + e.message;
                displayPayloads(undefined);
                markError(trigger);
            }
            finally {
                _calculating = false;
            }
        }
        
        function markError($el) {
            $output.style.outline = '1px solid red';
            if ($el && $el.style) {
                _errorTrigger = $el;
                $el.style.outline = '1px solid red';
            }
        }

        function clearError() {
            $output.style.outline = '1px solid #ccc';
            if (_errorTrigger) {
                _errorTrigger.style.outline = '';
                _errorTrigger = undefined;
            }
        }

        function signalDef(recordData, sofl = 1, eofl = 0, predictedSignalCount = 0, predictedSignalLength = 0, predictedWordLength = 2, predictedWords = null, tolerance = 100) {
            var counts = recordData.reduce((lengths, recordEntry) => Object.assign(lengths, { [recordEntry.length]: (lengths[recordEntry.length] || 0) + 1 }), {});
            var max = Object.keys(counts).reduce((max, key) => counts[key] > max.value ? { key: key, value: counts[key] } : max, { key: 0, value: 0 });

            var closest = max;
            if (predictedSignalLength) {
                predictedSignalCount = counts[predictedSignalLength];
                if (predictedSignalCount) {
                    closest = { key: predictedSignalLength, value: predictedSignalCount };
                } else {
                    console.log(counts);
                    throw new Error('no signals found with a total length of ' + predictedSignalLength + ', choose one of:\nsignal: { "lenght":count }\n' + JSON.stringify(counts, null, 2));
                }
            } else if (predictedSignalCount) {
                predictedSignalLength = Object.keys(counts).find(key => counts[key] == predictedSignalCount);
                if (predictedSignalLength) {
                    closest = { key: predictedSignalLength, value: predictedSignalCount };
                } else {
                    console.log(counts);
                    throw new Error('no signals found with a count of ' + predictedSignalCount + ', choose one of:\nsignal: { "lenght":count }\n' + JSON.stringify(counts, null, 2));
                }
            }

            predictedSignalCount = predictedSignalCount || max.value;
            predictedSignalLength = parseInt(predictedSignalLength || closest.key);

            var signals = recordData.filter(recordEntry => recordEntry.length === predictedSignalLength);

            var sof = signals.map(recordEntry => recordEntry.slice(0, sofl)).reduce((result, recordEntrySof) => recordEntrySof.map((timing, index) => (result[index] || 0) + timing)).map(timing => Math.round(timing / signals.length));
            var eof = eofl === 0 ? [] : signals.map(recordEntry => recordEntry.slice(-1 * eofl)).reduce((result, recordEntryEof) => recordEntryEof.map((timing, index) => (result[index] || 0) + timing)).map(timing => Math.round(timing / signals.length));

            predictedWordLength = predictedWords ? predictedWords[0].length : predictedWordLength;
            predictedSignal = signals[0];
            if (!predictedWords) {
                var word1 = [];
                var word2 = [];
                var sofLength = (sof || []).length;
                var idx = sofLength ? signals.findIndex(signal => signal[0] > sof[0] - tolerance && signal[0] < sof[0] + tolerance) : -1;
                predictedSignal = signals[idx === -1 ? 0 : idx];

                for (var i = 0; i < predictedWordLength; i++) {
                    word1[i] = predictedSignal[i + sofLength];
                    word2[i] = predictedSignal[i + sofLength + predictedWordLength];
                }
                predictedWords = [word1, word2];
            }

            var words = [].concat.apply([], signals.map(recordEntry => recordEntry.slice(sofl, -1 * eofl || undefined))).reduce((result, measurement, index, arr) => { if (index % predictedWords[0].length === 0) { var wordIndex = predictedWords.findIndex(word => word.every((timing, timingIndex) => Math.abs(arr[index + timingIndex] - timing) < tolerance)); if (wordIndex !== -1) { result[wordIndex].push(arr.slice(index, index + predictedWords[0].length)); } } return result; }, new Array(predictedWords.length).fill(null).map(() => [])).map((word) => word.reduce((result, arr) => arr.map((timing, index) => result[index] + timing), new Array(predictedWords[0].length).fill(0)).map(timing => Math.round(timing / word.length)));
            var length = Math.floor((predictedSignal.length - sofl - eofl) / predictedWordLength);

            var signal = { sof, eof, words, length };
            var debug = JSON.stringify(signal);

            return { recordData, predictedSignalCount, predictedSignalLength, sofl, eofl, counts, max, closest, signals, sof, eof, predictedWordLength, predictedWords, predictedSignal, tolerance, words, length, signal, debug };
        }

        function analyze(result) {
            var output = null;
            if (result && result.signals && result.signals.length) {
                output = {};
                output.payloads = result.signals.map(signal => parseSignal(signal, result));
                output.distinct = output.payloads.reduce((map, p) => { var key = p.join(''); map[key] = map[key] ? map[key] + 1 : 1; return map; }, {});
                output.guess = Object.keys(output.distinct).filter(key => key.indexOf('?') === -1).reduce((guess, s) => output.distinct[s] > (guess.max || 0) ? { signal: s, max: output.distinct[s] } : guess, {}).signal;
                if (!output.guess) {
                    output.guess = Object.keys(output.distinct).reduce((guess, s) => output.distinct[s] > (guess.max || 0) ? { signal: s, max: output.distinct[s] } : guess, {}).signal;
                }
                output.matches = output.payloads.reduce((count, s) => count += s.indexOf('?') === -1 ? 1 : 0, 0);
                output.misses = result.signals.length - output.matches;
                output.match = (output.distinct[output.guess] || 0) / result.signals.length;
                //output.match = output.matches / result.signals.length;
            }
            return output;
        }

        function parseSignal(signal, result) {
            if (!Array.isArray(signal) || !result || !result.words || !result.words.length)
                return null;

            var word0 = result.words[0];
            var word1 = result.words[1];

            if (!word0 || !word1)
                return null;

            var payload = [];
            var wordLength = word0.length;
            let tolerance = result.tolerance * wordLength; // NOTE: Include wordLength or check each individual value against tolerance?
            for (var i = result.sofl; i < signal.length - result.eofl; i += wordLength) {
                if (i + wordLength <= signal.length) {
                    var part = signal.slice(i, i + wordLength);
                    var dist = part.reduce((d, s, idx) => { d[0] += Math.abs(s - word0[idx]); d[1] += Math.abs(s - word1[idx]); return d; }, [0, 0]);
                    if (dist[0] < dist[1] && dist[0] <= result.tolerance) {
                        payload.push(0);
                    } else if (dist[1] <= result.tolerance) {
                        payload.push(1);
                    } else {
                        payload.push('?');
                    }
                }
            }

            return payload;
        }

        function displayPayloads(results, result) {
            $payloads.innerHTML = '';
            if (results && results.length) {
                $payloads.innerHTML += '========== BEST =========\n' + syntaxHighlight({
                    match: Math.round(result.payloads.match * 100) + '%',
                    guess: result.payloads.guess,
                    matches: result.payloads.distinct
                }) + '\n\n========== ALL =========\n';
                for (var result of results) {
                    $payloads.innerHTML += syntaxHighlight({
                        sof: result.sof,
                        eof: result.eof,
                        words: result.words,
                        match: Math.round(result.payloads.match * 100) + '%',
                        guess: result.payloads.guess,
                        matches: result.payloads.distinct
                    }) + '\n';
                }
            }
        }

    </script>
</head>

<body>
    <div class="container">
        <div class="section">
            <h3>Information</h3>
            <p>
                Fill in the information below to estimate the settings for a <a href="https://developer.athom.com/docs/apps/tutorial-Signals-Creating%20a%20Signal.html" target="_blank">433 mhz Homey signal</a>.
                The estimates are based on <a href="" target="_blank">these clculations</a>.
                More information on how to create a <a href="https://github.com/athombv/node-homey-rfdriver" target="_blank">433mhz driver</a> can be found <a href="https://github.com/athombv/node-homey-rfdriver" target="_blank">here</a>.
            </p>
        </div>

        <div class="section">
            <h3>Connect to Homey</h3>
            <p>
                To establish a connection and be able to record a signal from your Homey, we need the following connection settings.
                Alternatively just paste a previous recording or grab a recording yoursef by calling the api: <strong>api('POST', '/manager/rf/record')</strong> from the Chrome console while logged-in.
            </p>
            <div class="row">
                <label>What's your Homey's ip-address?</label>
                <input type="text" id="ip-address" placeholder="Homey ip-address" />
            </div>
            <div class="row">
                <label>Paste your <strong>authorization bearer token</strong> to allow a connection to your Homey. Can be found by (1) opening the <a href="https://developer.athom.com/tools/signals" target="_blank">recording page</a>. (2) Open the Chrome dev-tools [f12] and go to the (3) 'network' tab. (4) Press the record button on the page and (5) find the network call. (6) Paste the token from the 'authorization Bearer' in the request header (grab token only).</label>
                <input type="text" id="access-token" placeholder="access-token" />
            </div>
        </div>
        <div class="section">
            <h3>Recording</h3>
            <p>
                Press 'start recording' or paste your recorded signal into the textarea below.
                <div><strong>NOTE:</strong> The 'flat' signal from the <a href="https://developer.athom.com/tools/signals" target="_blank">recording page</a> <string>WONT</string> work...</div>
            </p>
            <p>When recording, generating the signal as many times as possible & count how many times the signal is send (i.e. count how often you press the button on your remote).</p>
            <div>
                <input type="button" id="record-button" value="start recording" title="record" /><input type="button" id="calculate-button" value="calculate" title="calculate" />
            </div>
            <textarea id="record-data" placeholder="signal recording data"></textarea>
        </div>
        <div class="section">
            <h3>Signal definition</h3>
            <p>These values will be extracted from the signal, but can be overridden to gain better results.</p>
            <div class="row">
                <p>How many times did you send the signal (estimate)?</p>
                <input type="text" id="predicted-signal-count" placeholder="predicted signal count" />
            </div>
            <div class="row">
                <p>What is the predicted start of frame (sof) length?</p>
                <input type="text" id="sofl" placeholder="start of frame (sof)" />
            </div>
            <div class="row">
                <p>What is the predicted end of frame (eof) length?</p>
                <input type="text" id="eofl" placeholder="end of frame (eof)" />
            </div>
            <div class="row">
                <p>What is the predicted signal length (including sof & eof)?</p>
                <input type="text" id="predicted-signal-length" placeholder="predicted total signal length" />
            </div>
            <div class="row">
                <p>What is the predicted word length?</p>
                <input type="text" id="predicted-word-length" placeholder="predicted total signal length" />
            </div>
            <div class="row">
                <p>What are the predicted words (overrides predicted word length)?</p>
                <input type="text" id="predicted-words" placeholder="[[n, ], ...]" />
            </div>
            <div class="row">
                <p>Tolerance</p>
                <input type="text" id="tolerance" placeholder="100" />
            </div>
        </div>
        <div class="section">
            <h3>Predicted Signal (best match)</h3>
            <p>See console output for details & intermediate results.</p>
            <pre id="output"></pre>
        </div>

        <div class="section">
            <h3>Predicted Payloads</h3>
            <pre id="payloads"></pre>
        </div>

    </div>
    <script type="text/javascript">init();</script>
</body>

</html>
